{% extends "base.html" %}
{% block title %}Plate Calculator{% endblock %}
{% block content %}
<div id="pc">
  <div id="pcTitle">
    <h1>Plate Calculator</h1>
    <br>
    <p>Enter a target weight, exclude plates and/or adjust the bar weight as needed:</p>
  </div>
  <form id="pcForm" action="" method="get">
      <input type="number" id="targetWeight" min="0" step="5" required>
      <label for="target_weight"> Target Weight (lbs)</label>
      <p id="errorMessage" class="errorMessage"></p>
      <br>
      {# <p>Imperial (lbs) or Metric (kg)?</p>
      <input type="radio" name="metric_or_imperial" id="imperial">
      <label for="imperial"> Imperial</label><br>
      <input type="radio" name="metric_or_imperial" id="metric">
      <label for="metric"> Metric</label><br>
      <br> #}
      <input type="number" name="bar_weight" id="barWeight" value=45 min="0" step="5">
      <label for="bar_weight"> Bar Weight (lbs)</label><br>
      <p>Select Available Plates:</p>
      <div class="checkbox-group">
      {% for plate in plates %}
      <label for="{{plate}}">
        <input type="checkbox" checked="checked" name="excludeWeights" value={{plate}}>
      {{plate}} lbs</label>
      {% endfor %}
      </div>
      <br>
      <button type="button" onclick="submitForm()">Calculate</button>
    </form>
    <div id="results">
      <h4 id="resultsTitle">Plates needed:</h4>
      <div id="resultContainer"></div>
    </div>
</div>
{% endblock %}
{% block footer %}
<!-- The following code was written by ChatGPT and edited to work by me, I take no credit for this and do not know nearly enough JS-->
<script>
function submitForm() {
  var targetWeight = parseFloat(document.getElementById("targetWeight").value);
  var barWeight = parseFloat(document.getElementById("barWeight").value);

  
  console.log(targetWeight < barWeight)

  // Check if the required field is above the value of the optional field
  if (targetWeight < barWeight) {
    console.log("Target weight less than bar")
    errorMessage.textContent = "The target weight is less than the bar!";
    document.getElementById("pc_form").reset(); 
    return; // Prevent form submission
  }
  errorMessage.textContent = "";

  var excludeWeights = document.querySelectorAll('input[name="excludeWeights"]:not(:checked)');
  var apiUrl = window.location + "/" + encodeURIComponent(targetWeight);
  if (excludeWeights.length > 0) {
    var excludeWeightsArray = Array.from(excludeWeights).map(function (checkbox) {
      return 'exclude_plates=' + encodeURIComponent(checkbox.value);
    });

    apiUrl += '?' + excludeWeightsArray.join('&');
  }
  console.log("API URL: ", apiUrl);

  // Submit to API
  fetch(apiUrl)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok');
      }
      return response.json();
    })
    .then(data => {

      var resultContainer = document.getElementById("resultContainer");

      // Clear previous results
      resultContainer.innerHTML = '';

      // Iterate over properties of the JSON object and display the result
      var plates = data['plate_calculation']['plates']
      for (var number in plates) {
        if (plates.hasOwnProperty(number)) {
          var count = plates[number];

          // Create a new paragraph element for each number and count
          var paragraph = document.createElement("p");
          paragraph.textContent = number + " lbs x " + count;

          // Append the paragraph to the result container
          resultContainer.appendChild(paragraph);
        }
      }
    })
    .catch(error => {
      console.error('Error:', error);
      // Optionally handle errors (no thanks)
    });
}
</script> 
{% endblock%}